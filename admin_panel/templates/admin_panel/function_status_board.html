{% extends "base.html" %}
{% load static %}

{% block title %}Function Status Board{% endblock %}

{% block extra_css %}
<style>
    .kanban-container {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding-bottom: 20px;
    }
    .kanban-column {
        min-width: 280px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        flex-shrink: 0;
    }
    .kanban-header {
        font-weight: bold;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        color: white;
    }
    .kanban-card {
        background: white;
        border-radius: 5px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .function-app {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    .function-name {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .function-meta {
        font-size: 0.75rem;
        margin-top: 8px;
    }
    .filter-bar {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-columns"></i> Function Status Board</h2>
            <p class="text-muted">Kanban-style view of all functions across applications</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'admin_panel:app_status_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Filter by App</label>
                <select name="app" class="form-select" onchange="this.form.submit()">
                    <option value="">All Apps</option>
                    {% for app in apps %}
                    <option value="{{ app.app_code }}" {% if app_filter == app.app_code %}selected{% endif %}>
                        {{ app.app_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Filter by Priority</label>
                <select name="priority" class="form-select" onchange="this.form.submit()">
                    <option value="">All Priorities</option>
                    <option value="critical" {% if priority_filter == 'critical' %}selected{% endif %}>Critical</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <a href="{% url 'admin_panel:function_status_board' %}" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-redo"></i> Clear Filters
                </a>
            </div>
        </form>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-container">
        <!-- Planned Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-secondary">
                <i class="fas fa-lightbulb"></i> Planned
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.planned.count }}</span>
            </div>
            {% for func in kanban_columns.planned %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.is_api %}<i class="fas fa-code" title="API"></i>{% endif %}
                    {% if func.is_ui %}<i class="fas fa-desktop" title="UI"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No planned functions</small></p>
            {% endfor %}
        </div>

        <!-- Developing Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-info">
                <i class="fas fa-code"></i> Developing
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.developing.count }}</span>
            </div>
            {% for func in kanban_columns.developing %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.assigned_to %}
                    <i class="fas fa-user" title="{{ func.assigned_to.email }}"></i>
                    {% endif %}
                    {% if func.is_api %}<i class="fas fa-code" title="API"></i>{% endif %}
                    {% if func.is_ui %}<i class="fas fa-desktop" title="UI"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No developing functions</small></p>
            {% endfor %}
        </div>

        <!-- Completed Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-success">
                <i class="fas fa-check"></i> Completed
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.completed.count }}</span>
            </div>
            {% for func in kanban_columns.completed %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.has_tests %}<i class="fas fa-vial" title="Has Tests"></i>{% endif %}
                    {% if func.has_documentation %}<i class="fas fa-book" title="Has Docs"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No completed functions</small></p>
            {% endfor %}
        </div>

        <!-- UAT Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-warning text-dark">
                <i class="fas fa-user-check"></i> UAT
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.uat.count }}</span>
            </div>
            {% for func in kanban_columns.uat %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.has_tests %}<i class="fas fa-vial" title="Has Tests"></i>{% endif %}
                    {% if func.has_documentation %}<i class="fas fa-book" title="Has Docs"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No functions in UAT</small></p>
            {% endfor %}
        </div>

        <!-- Soft Launch Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-primary">
                <i class="fas fa-rocket"></i> Soft Launch
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.softlaunch.count }}</span>
            </div>
            {% for func in kanban_columns.softlaunch %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.has_tests %}<i class="fas fa-vial" title="Has Tests"></i>{% endif %}
                    {% if func.has_documentation %}<i class="fas fa-book" title="Has Docs"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No soft launch functions</small></p>
            {% endfor %}
        </div>

        <!-- Production Column -->
        <div class="kanban-column">
            <div class="kanban-header" style="background: #28a745;">
                <i class="fas fa-star"></i> Production
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.production.count }}</span>
            </div>
            {% for func in kanban_columns.production %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    {% if func.has_tests %}<i class="fas fa-vial" title="Has Tests"></i>{% endif %}
                    {% if func.has_documentation %}<i class="fas fa-book" title="Has Docs"></i>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No production functions</small></p>
            {% endfor %}
        </div>

        <!-- Blocked Column -->
        <div class="kanban-column">
            <div class="kanban-header bg-danger">
                <i class="fas fa-ban"></i> Blocked
                <span class="badge bg-light text-dark ms-2">{{ kanban_columns.blocked.count }}</span>
            </div>
            {% for func in kanban_columns.blocked %}
            <div class="kanban-card" onclick="editFunction({{ func.id }})">
                <div class="function-app">{{ func.app.app_name }}</div>
                <div class="function-name">{{ func.function_name }}</div>
                <div class="function-meta">
                    <span class="badge bg-{{ func.get_priority_color }}">{{ func.get_priority_display }}</span>
                    <div class="text-danger mt-2" style="font-size: 0.7rem;">
                        <i class="fas fa-exclamation-circle"></i> {{ func.blocker_reason|truncatewords:8 }}
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted text-center"><small>No blocked functions</small></p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Edit Function Modal -->
<div class="modal fade" id="editFunctionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Function Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalFunctionInfo"></div>
                <div class="mb-3">
                    <label class="form-label">New Status</label>
                    <select id="modalStatusSelect" class="form-select">
                        <option value="planned">Planned</option>
                        <option value="developing">Developing</option>
                        <option value="completed">Completed</option>
                        <option value="uat">UAT</option>
                        <option value="softlaunch">Soft Launch</option>
                        <option value="production">Production</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFunctionId = null;
const modal = new bootstrap.Modal(document.getElementById('editFunctionModal'));

function editFunction(functionId) {
    currentFunctionId = functionId;
    // In a real implementation, you'd fetch function details via AJAX
    // For now, just show the modal
    modal.show();
}

function saveStatus() {
    if (!currentFunctionId) return;

    const newStatus = document.getElementById('modalStatusSelect').value;

    fetch(`/admin-panel/functions/${currentFunctionId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `status=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            modal.hide();
            // Reload page to show updated board
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update status');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
