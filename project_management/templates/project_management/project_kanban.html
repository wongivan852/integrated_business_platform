{% extends 'project_management/base.html' %}
{% load static %}

{% block page_title %}{{ project.name }} - Kanban Board{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item">
    <a href="{% url 'project_management:project_detail' project.pk %}">{{ project.name }}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">Kanban Board</li>
{% endblock %}

{% block page_heading %}
    <i class="fas fa-columns"></i> {{ project.name }}
{% endblock %}

{% block page_subtitle %}
<div class="d-flex align-items-center gap-3">
    <span class="badge bg-light text-dark">Kanban Board</span>
    <span class="status-badge {{ project.status }}">{{ project.get_status_display }}</span>
</div>
{% endblock %}

{% block header_actions %}
<div class="view-switcher me-3">
    <a href="{% url 'project_management:project_kanban' project.pk %}" class="btn active">
        <i class="fas fa-columns"></i> Kanban
    </a>
    <a href="{% url 'project_management:project_gantt' project.pk %}" class="btn">
        <i class="fas fa-chart-bar"></i> Gantt
    </a>
</div>
<a href="{% url 'project_management:project_detail' project.pk %}" class="btn btn-outline-light">
    <i class="fas fa-arrow-left"></i> Back
</a>
{% endblock %}

{% block page_css %}
<style>
/* Kanban Board Styles */
.kanban-toolbar {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kanban-board {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding: 1rem 0;
    min-height: 500px;
}

.kanban-column {
    min-width: 320px;
    max-width: 320px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.column-header {
    padding: 1rem;
    border-bottom: 2px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.column-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: #333;
}

.column-count {
    background: #6c757d;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.875rem;
}

.wip-limit {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.875rem;
    margin-left: 0.5rem;
}

.wip-limit.normal {
    background: #d4edda;
    color: #155724;
}

.wip-limit.exceeded {
    background: #f8d7da;
    color: #721c24;
    font-weight: 600;
}

.column-tasks {
    flex: 1;
    padding: 1rem;
    min-height: 100px;
    overflow-y: auto;
}

.task-card {
    background: white;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s;
    border-left: 3px solid #dee2e6;
}

.task-card:hover {
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.task-card.dragging {
    opacity: 0.5;
}

.ghost-card {
    background: #e9ecef;
    border: 2px dashed #6c757d;
}

.task-card.priority-low { border-left-color: #6c757d; }
.task-card.priority-medium { border-left-color: #ffc107; }
.task-card.priority-high { border-left-color: #fd7e14; }
.task-card.priority-critical { border-left-color: #dc3545; }

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
}

.drag-handle {
    color: #adb5bd;
    cursor: move;
    font-size: 0.9rem;
    padding: 0.25rem;
    flex-shrink: 0;
}

.drag-handle:hover {
    color: #6c757d;
}

.task-title {
    font-weight: 600;
    color: #333;
    flex: 1;
    font-size: 0.9rem;
    cursor: pointer;
}

.task-code {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: monospace;
}

.task-meta {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.task-badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 10px;
}

.task-assignees {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.assignee-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
}

.btn-add-task {
    margin: 0.5rem 1rem;
    padding: 0.5rem;
    border: 2px dashed #dee2e6;
    background: transparent;
    border-radius: 6px;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-add-task:hover {
    border-color: #667eea;
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.column-empty {
    text-align: center;
    padding: 2rem 1rem;
    color: #adb5bd;
}

/* Quick Add Modal */
.quick-add-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 1050;
    min-width: 400px;
    display: none;
}

.quick-add-modal.active {
    display: block;
}

.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1040;
    display: none;
}

.modal-backdrop.active {
    display: block;
}
</style>
{% endblock %}

{% block page_content %}
<!-- Kanban Toolbar -->
<div class="kanban-toolbar">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="d-flex gap-2">
                <input type="search" id="searchTasks" class="form-control" placeholder="Search tasks..." style="max-width: 300px;">
                <select id="filterStatus" class="form-select" style="max-width: 150px;">
                    <option value="">All Status</option>
                    <option value="todo">To Do</option>
                    <option value="in_progress">In Progress</option>
                    <option value="review">Review</option>
                    <option value="done">Done</option>
                </select>
                <select id="filterPriority" class="form-select" style="max-width: 150px;">
                    <option value="">All Priority</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
        </div>
        <div class="col-md-4 text-end">
            {% if can_edit %}
            <button class="btn btn-primary" onclick="showQuickAddModal()">
                <i class="fas fa-plus"></i> Quick Add Task
            </button>
            {% endif %}
            {% if can_manage_columns %}
            <button class="btn btn-outline-secondary" onclick="alert('Column management coming soon')">
                <i class="fas fa-cog"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Kanban Board -->
<div class="kanban-board" id="kanbanBoard">
    {% for column in columns %}
    <div class="kanban-column" data-column-id="{{ column.pk }}">
        <div class="column-header" style="border-top: 3px solid {{ column.color }};">
            <h3 class="column-title">{{ column.name }}</h3>
            <div class="d-flex align-items-center">
                <span class="column-count">{{ column.task_count }}</span>
                {% if column.wip_limit %}
                <span class="wip-limit {% if column.is_over_wip_limit %}exceeded{% else %}normal{% endif %}">
                    {{ column.task_count }}/{{ column.wip_limit }}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="column-tasks sortable" data-column-id="{{ column.pk }}" id="column-{{ column.pk }}">
            {% for task in column.tasks.all %}
            <div class="task-card priority-{{ task.priority }}"
                 data-task-id="{{ task.pk }}"
                 data-task-url="{% url 'project_management:task_detail' project.pk task.pk %}">
                <div class="task-header">
                    <span class="drag-handle" title="Drag to move"><i class="fas fa-grip-vertical"></i></span>
                    <div class="task-title">{{ task.title }}</div>
                </div>
                <div class="task-code">{{ task.task_code }}</div>

                <div class="task-meta">
                    <span class="task-badge priority-badge {{ task.priority }}">
                        {{ task.get_priority_display }}
                    </span>
                    <span class="task-badge status-badge {{ task.status }}">
                        {{ task.get_status_display }}
                    </span>
                    {% if task.due_date %}
                    <span class="task-badge" style="background: #e9ecef; color: #495057;">
                        <i class="fas fa-calendar"></i> {{ task.due_date|date:"M d" }}
                    </span>
                    {% endif %}
                </div>

                {% if task.assigned_to.all %}
                <div class="task-assignees">
                    {% for user in task.assigned_to.all|slice:":3" %}
                    <div class="assignee-avatar" title="{{ user.get_full_name|default:user.email }}">
                        {{ user.get_full_name.0|default:user.email.0|upper }}
                    </div>
                    {% endfor %}
                    {% if task.assigned_to.count > 3 %}
                    <div class="assignee-avatar">+{{ task.assigned_to.count|add:"-3" }}</div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% empty %}
            <div class="column-empty">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <div>No tasks</div>
            </div>
            {% endfor %}
        </div>

        {% if can_edit %}
        <button class="btn-add-task" onclick="quickAddTaskToColumn({{ column.pk }}, event)">
            <i class="fas fa-plus"></i> Add Task
        </button>
        {% endif %}
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            No columns created yet.
            {% if can_manage_columns %}
            Click "Add Column" to get started.
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Quick Add Modal -->
<div class="modal-backdrop" id="modalBackdrop" onclick="hideQuickAddModal()"></div>
<div class="quick-add-modal" id="quickAddModal">
    <h5 class="mb-3">Quick Add Task</h5>
    <form id="quickAddForm" onsubmit="submitQuickAdd(event)">
        <div class="mb-3">
            <label class="form-label">Task Title *</label>
            <input type="text" class="form-control" id="quickTaskTitle" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Column</label>
            <select class="form-select" id="quickTaskColumn">
                {% for column in columns %}
                <option value="{{ column.pk }}">{{ column.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="hideQuickAddModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
    </form>
</div>
{% endblock %}

{% block page_js %}
<!-- Sortable.js for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Initialize Sortable on each column
document.querySelectorAll('.sortable').forEach(column => {
    new Sortable(column, {
        group: 'shared',
        animation: 150,
        ghostClass: 'ghost-card',
        dragClass: 'dragging',
        handle: '.drag-handle',  // Only drag by the handle icon
        onEnd: function(evt) {
            updateTaskPosition(evt);
        }
    });
});

// Add click handlers to task cards
document.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('click', function(e) {
        // Don't navigate if clicking the drag handle
        if (e.target.closest('.drag-handle')) {
            return;
        }
        const url = this.dataset.taskUrl;
        if (url) {
            window.location.href = url;
        }
    });
});

// Update task position via API
function updateTaskPosition(evt) {
    const taskId = evt.item.dataset.taskId;
    const columnId = evt.to.dataset.columnId;
    const position = evt.newIndex;

    fetch(`/project-management/{{ project.pk }}/api/tasks/${taskId}/move/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            column_id: columnId,
            position: position
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.wip_limit_exceeded) {
            alert(data.error);
            // Revert the move
            evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
        } else if (!data.success) {
            alert('Error: ' + data.error);
            // Revert the move
            evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to move task');
        // Revert the move
        evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
    });
}

// Quick Add Modal Functions
function showQuickAddModal() {
    document.getElementById('modalBackdrop').classList.add('active');
    document.getElementById('quickAddModal').classList.add('active');
    document.getElementById('quickTaskTitle').focus();
}

function hideQuickAddModal() {
    document.getElementById('modalBackdrop').classList.remove('active');
    document.getElementById('quickAddModal').classList.remove('active');
    document.getElementById('quickAddForm').reset();
}

function quickAddTaskToColumn(columnId, event) {
    event.stopPropagation();
    showQuickAddModal();
    document.getElementById('quickTaskColumn').value = columnId;
}

function submitQuickAdd(event) {
    event.preventDefault();

    const title = document.getElementById('quickTaskTitle').value;
    const columnId = document.getElementById('quickTaskColumn').value;

    fetch(`/project-management/{{ project.pk }}/api/tasks/quick-create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            title: title,
            column_id: columnId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show new task
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create task');
    });
}

// Search and Filter
document.getElementById('searchTasks').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    filterTasks();
});

document.getElementById('filterStatus').addEventListener('change', filterTasks);
document.getElementById('filterPriority').addEventListener('change', filterTasks);

function filterTasks() {
    const search = document.getElementById('searchTasks').value.toLowerCase();
    const status = document.getElementById('filterStatus').value;
    const priority = document.getElementById('filterPriority').value;

    document.querySelectorAll('.task-card').forEach(card => {
        const title = card.querySelector('.task-title').textContent.toLowerCase();
        const code = card.querySelector('.task-code').textContent.toLowerCase();
        const cardStatus = card.querySelector('.status-badge').className.split(' ').pop();
        const cardPriority = card.classList.contains('priority-low') ? 'low' :
                           card.classList.contains('priority-medium') ? 'medium' :
                           card.classList.contains('priority-high') ? 'high' : 'critical';

        const matchesSearch = !search || title.includes(search) || code.includes(search);
        const matchesStatus = !status || cardStatus === status;
        const matchesPriority = !priority || cardPriority === priority;

        if (matchesSearch && matchesStatus && matchesPriority) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Prevent click on drag
document.querySelectorAll('.task-card').forEach(card => {
    let dragStarted = false;

    card.addEventListener('mousedown', function() {
        dragStarted = false;
    });

    card.addEventListener('mousemove', function() {
        dragStarted = true;
    });

    card.addEventListener('click', function(e) {
        if (dragStarted) {
            e.preventDefault();
            e.stopPropagation();
        }
    });
});
</script>
{% endblock %}
