{% extends 'base.html' %}

{% block title %}Task Cost Tracking - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'project_management:project_list' %}">Projects</a></li>
            <li class="breadcrumb-item"><a href="{% url 'project_management:project_detail' project.pk %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'project_management:evm_dashboard' project.pk %}">EVM Dashboard</a></li>
            <li class="breadcrumb-item active">Task Cost Tracking</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-tasks"></i> Task Cost Tracking</h2>
        <a href="{% url 'project_management:project_costs' project.pk %}" class="btn btn-outline-primary">
            <i class="fas fa-dollar-sign"></i> Project Costs
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Planned Cost</h6>
                    <h3 class="text-primary mb-0">${{ total_planned|floatformat:0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Actual Cost</h6>
                    <h3 class="mb-0">${{ total_actual|floatformat:0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Variance</h6>
                    <h3 class="{% if total_variance <= 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                        {% if total_variance > 0 %}+{% endif %}${{ total_variance|floatformat:0 }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Cost Efficiency</h6>
                    <h3 class="{% if total_planned > 0 and total_actual <= total_planned %}text-success{% else %}text-danger{% endif %} mb-0">
                        {% if total_planned > 0 %}
                        {{ total_actual|floatformat:0|add:"0"|div:total_planned|floatformat:1 }}%
                        {% else %}
                        0%
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Over Budget -->
    {% if tasks_over_budget %}
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Tasks Over Budget (Top 10)</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Task Code</th>
                            <th>Task Name</th>
                            <th class="text-right">Planned Cost</th>
                            <th class="text-right">Actual Cost</th>
                            <th class="text-right">Variance</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tasks_over_budget %}
                        <tr>
                            <td>
                                <a href="{% url 'project_management:task_detail' project.pk item.task_cost.task.pk %}">
                                    {{ item.task_cost.task.task_code }}
                                </a>
                            </td>
                            <td>{{ item.task_cost.task.name }}</td>
                            <td class="text-right">${{ item.task_cost.planned_cost|floatformat:2 }}</td>
                            <td class="text-right">${{ item.task_cost.actual_cost|floatformat:2 }}</td>
                            <td class="text-right text-danger">
                                <strong>+${{ item.variance|floatformat:2 }}</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-{{ item.task_cost.task.status }}">
                                    {{ item.task_cost.task.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tasks Under Budget -->
    {% if tasks_under_budget %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-check-circle"></i> Tasks Under Budget (Top 10)</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Task Code</th>
                            <th>Task Name</th>
                            <th class="text-right">Planned Cost</th>
                            <th class="text-right">Actual Cost</th>
                            <th class="text-right">Savings</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in tasks_under_budget %}
                        <tr>
                            <td>
                                <a href="{% url 'project_management:task_detail' project.pk item.task_cost.task.pk %}">
                                    {{ item.task_cost.task.task_code }}
                                </a>
                            </td>
                            <td>{{ item.task_cost.task.name }}</td>
                            <td class="text-right">${{ item.task_cost.planned_cost|floatformat:2 }}</td>
                            <td class="text-right">${{ item.task_cost.actual_cost|floatformat:2 }}</td>
                            <td class="text-right text-success">
                                <strong>-${{ item.variance|floatformat:2 }}</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-{{ item.task_cost.task.status }}">
                                    {{ item.task_cost.task.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Task Costs -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-list"></i> All Task Costs</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="taskCostsTable">
                    <thead>
                        <tr>
                            <th>Task Code</th>
                            <th>Task Name</th>
                            <th>Cost Type</th>
                            <th class="text-right">Planned</th>
                            <th class="text-right">Actual</th>
                            <th class="text-right">Variance</th>
                            <th class="text-right">% of Plan</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tc in task_costs %}
                        {% with variance=tc.actual_cost|add:"-"|add:tc.planned_cost %}
                        <tr>
                            <td>
                                <a href="{% url 'project_management:task_detail' project.pk tc.task.pk %}">
                                    {{ tc.task.task_code }}
                                </a>
                            </td>
                            <td>{{ tc.task.name }}</td>
                            <td>
                                <span class="badge badge-secondary">{{ tc.get_cost_type_display }}</span>
                            </td>
                            <td class="text-right">${{ tc.planned_cost|floatformat:2 }}</td>
                            <td class="text-right">${{ tc.actual_cost|floatformat:2 }}</td>
                            <td class="text-right {% if variance > 0 %}text-danger{% elif variance < 0 %}text-success{% endif %}">
                                {% if variance > 0 %}+{% endif %}${{ variance|floatformat:2 }}
                            </td>
                            <td class="text-right">
                                {% if tc.planned_cost > 0 %}
                                {% widthratio tc.actual_cost tc.planned_cost 100 %}%
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="badge badge-{{ tc.task.status }}">
                                    {{ tc.task.get_status_display }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if user_role in 'owner,manager' %}
                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCost({{ tc.id }}, {{ tc.task.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="fas fa-lock"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endwith %}
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                No task cost data available. Costs are tracked at the task level.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Cost Modal -->
<div class="modal fade" id="editTaskCostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task Cost</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editTaskCostForm">
                    <input type="hidden" id="taskCostId">
                    <input type="hidden" id="taskId">

                    <div class="form-group">
                        <label>Cost Type</label>
                        <select class="form-control" id="costType">
                            <option value="total">Total Cost</option>
                            <option value="labor">Labor</option>
                            <option value="materials">Materials</option>
                            <option value="equipment">Equipment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Planned Cost</label>
                        <input type="number" class="form-control" id="plannedCost" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Actual Cost</label>
                        <input type="number" class="form-control" id="actualCost" step="0.01" min="0" required>
                    </div>

                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle"></i> Variance will be calculated automatically</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTaskCost()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-todo { background-color: #6c757d; }
    .badge-in_progress { background-color: #007bff; }
    .badge-review { background-color: #ffc107; }
    .badge-completed { background-color: #28a745; }
    .badge-blocked { background-color: #dc3545; }
</style>

<script>
    function editTaskCost(taskCostId, taskId) {
        // In a real implementation, fetch current values from the server
        document.getElementById('taskCostId').value = taskCostId;
        document.getElementById('taskId').value = taskId;

        // Show modal
        $('#editTaskCostModal').modal('show');
    }

    function saveTaskCost() {
        const taskId = document.getElementById('taskId').value;
        const costType = document.getElementById('costType').value;
        const plannedCost = document.getElementById('plannedCost').value;
        const actualCost = document.getElementById('actualCost').value;

        // Validate
        if (!plannedCost || !actualCost) {
            alert('Please fill in all required fields');
            return;
        }

        // Send AJAX request
        fetch(`{% url 'project_management:api_update_task_cost' project.pk 0 %}`.replace('/0/', `/${taskId}/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                cost_type: costType,
                planned_cost: parseFloat(plannedCost),
                actual_cost: parseFloat(actualCost)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page
                $('#editTaskCostModal').modal('hide');
                location.reload();
            } else {
                alert('Error updating task cost: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating task cost');
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Make table sortable
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('taskCostsTable');
        if (table && table.rows.length > 1) {
            // Add sort icons to headers
            const headers = table.querySelectorAll('thead th');
            headers.forEach((header, index) => {
                if (index < headers.length - 1) { // Exclude actions column
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', () => sortTable(table, index));
                }
            });
        }
    });

    function sortTable(table, columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Determine sort direction
        const isAscending = table.dataset.sortOrder !== 'asc';
        table.dataset.sortOrder = isAscending ? 'asc' : 'desc';

        // Sort rows
        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();

            // Try to parse as number
            const aNum = parseFloat(aValue.replace(/[$,]/g, ''));
            const bNum = parseFloat(bValue.replace(/[$,]/g, ''));

            if (!isNaN(aNum) && !isNaN(bNum)) {
                return isAscending ? aNum - bNum : bNum - aNum;
            } else {
                return isAscending
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            }
        });

        // Re-append rows
        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}
