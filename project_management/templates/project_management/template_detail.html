{% extends 'base.html' %}

{% block title %}{{ template.name }} - Template{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'project_management:template_list' %}">Templates</a></li>
            <li class="breadcrumb-item active">{{ template.name }}</li>
        </ol>
    </nav>

    <!-- Template Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-layer-group"></i> {{ template.name }}
                <span class="badge badge-{{ template.category }} ms-2">
                    {{ template.get_category_display }}
                </span>
                {% if template.is_public %}
                <span class="badge badge-success ms-2">
                    <i class="fas fa-globe"></i> Public
                </span>
                {% else %}
                <span class="badge badge-secondary ms-2">
                    <i class="fas fa-lock"></i> Private
                </span>
                {% endif %}
            </h2>
            <p class="text-muted mb-0">{{ template.description }}</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'project_management:project_from_template' template.id %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Use Template
            </a>
            {% if is_owner %}
            <a href="{% url 'project_management:template_edit' template.id %}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Edit
            </a>
            <button class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Template Information -->
        <div class="col-md-8">
            <!-- Overview Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Template Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-value text-primary">{{ template_tasks.count }}</div>
                            <div class="metric-label">Tasks</div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-value text-info">{{ template.default_duration_days }}</div>
                            <div class="metric-label">Days</div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-value text-warning">{{ total_hours|floatformat:0 }}</div>
                            <div class="metric-label">Est. Hours</div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="metric-value text-success">{{ usage_count }}</div>
                            <div class="metric-label">Times Used</div>
                        </div>
                    </div>

                    {% if template.estimated_budget %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-dollar-sign"></i>
                        <strong>Estimated Budget:</strong> ${{ template.estimated_budget|floatformat:2 }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Task List -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Template Tasks ({{ template_tasks.count }})</h5>
                    {% if is_owner %}
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if template_tasks %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th>Task Name</th>
                                    <th class="text-center">Est. Hours</th>
                                    <th class="text-center">Role</th>
                                    <th class="text-center">Dependencies</th>
                                    <th class="text-center">Milestone</th>
                                    {% if is_owner %}
                                    <th class="text-center" style="width: 100px;">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in template_tasks %}
                                <tr>
                                    <td class="text-muted">{{ task.sequence_number }}</td>
                                    <td>
                                        <strong>{{ task.name }}</strong>
                                        {% if task.description %}
                                        <br>
                                        <small class="text-muted">{{ task.description|truncatewords:15 }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-info">{{ task.estimated_hours }} hrs</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-secondary">{{ task.get_assignee_role_display }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% if task.id in dependency_map %}
                                        <span class="badge badge-warning" title="Has dependencies">
                                            {{ dependency_map|get_item:task.id|length }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if task.is_milestone %}
                                        <i class="fas fa-flag text-danger" title="Milestone"></i>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    {% if is_owner %}
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="removeTask({{ task.id }}, '{{ task.name }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No tasks defined in this template yet.</p>
                        {% if is_owner %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus"></i> Add First Task
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dependencies Visualization -->
            {% if dependency_map %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Task Dependencies</h5>
                </div>
                <div class="card-body">
                    <div class="dependency-list">
                        {% for task in template_tasks %}
                            {% if task.id in dependency_map %}
                            <div class="dependency-item mb-3">
                                <strong>{{ task.name }}</strong> depends on:
                                <ul class="list-unstyled ms-3 mt-2">
                                    {% for dep in dependency_map|get_item:task.id %}
                                    <li>
                                        <i class="fas fa-arrow-right text-primary"></i>
                                        {{ dep.depends_on.name }}
                                        <span class="badge badge-secondary ms-2">{{ dep.dependency_type }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Template Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info"></i> Template Information</h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Created By:</dt>
                        <dd class="col-sm-7">{{ template.created_by.get_full_name }}</dd>

                        <dt class="col-sm-5">Created:</dt>
                        <dd class="col-sm-7">{{ template.created_at|date:"M d, Y" }}</dd>

                        <dt class="col-sm-5">Last Updated:</dt>
                        <dd class="col-sm-7">{{ template.updated_at|date:"M d, Y" }}</dd>

                        <dt class="col-sm-5">Category:</dt>
                        <dd class="col-sm-7">
                            <span class="badge badge-{{ template.category }}">
                                {{ template.get_category_display }}
                            </span>
                        </dd>

                        <dt class="col-sm-5">Visibility:</dt>
                        <dd class="col-sm-7">
                            {% if template.is_public %}
                            <span class="badge badge-success">Public</span>
                            {% else %}
                            <span class="badge badge-secondary">Private</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">Times Used:</dt>
                        <dd class="col-sm-7">{{ usage_count }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Recent Usage -->
            {% if recent_uses %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history"></i> Recent Usage</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for project in recent_uses %}
                        <a href="{% url 'project_management:project_detail' project.pk %}"
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ project.name }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ project.created_at|date:"M d, Y" }}
                                    </small>
                                </div>
                                <span class="badge badge-{{ project.status }}">
                                    {{ project.get_status_display }}
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Actions Card -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-cogs"></i> Actions</h6>
                </div>
                <div class="card-body">
                    <a href="{% url 'project_management:project_from_template' template.id %}"
                       class="btn btn-success btn-block mb-2">
                        <i class="fas fa-plus"></i> Create Project from Template
                    </a>
                    {% if is_owner %}
                    <a href="{% url 'project_management:template_edit' template.id %}"
                       class="btn btn-warning btn-block mb-2">
                        <i class="fas fa-edit"></i> Edit Template
                    </a>
                    <button class="btn btn-outline-secondary btn-block mb-2" onclick="duplicateTemplate()">
                        <i class="fas fa-copy"></i> Duplicate Template
                    </button>
                    <button class="btn btn-danger btn-block" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Delete Template
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
{% if is_owner %}
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Task to Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label class="form-label">Task Name *</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Estimated Hours *</label>
                            <input type="number" class="form-control" id="estimatedHours"
                                   value="8" min="0.5" step="0.5" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Assignee Role *</label>
                            <select class="form-control" id="assigneeRole">
                                <option value="member">Team Member</option>
                                <option value="lead">Team Lead</option>
                                <option value="manager">Project Manager</option>
                                <option value="owner">Project Owner</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTask()">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this template?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'project_management:template_delete' template.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Template</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }

    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    .dependency-item {
        padding: 10px;
        background: #f8f9fa;
        border-left: 3px solid #007bff;
        border-radius: 4px;
    }

    .badge-software { background-color: #007bff; }
    .badge-construction { background-color: #fd7e14; }
    .badge-marketing { background-color: #e83e8c; }
    .badge-research { background-color: #6f42c1; }
    .badge-event { background-color: #20c997; }
    .badge-consulting { background-color: #17a2b8; }
    .badge-design { background-color: #d63384; }
    .badge-other { background-color: #6c757d; }

    .badge-planning { background-color: #6c757d; }
    .badge-active { background-color: #28a745; }
    .badge-on_hold { background-color: #ffc107; }
    .badge-completed { background-color: #17a2b8; }
    .badge-cancelled { background-color: #dc3545; }
</style>

<script>
    function confirmDelete() {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    {% if is_owner %}
    function addTask() {
        const name = document.getElementById('taskName').value;
        const description = document.getElementById('taskDescription').value;
        const estimatedHours = document.getElementById('estimatedHours').value;
        const assigneeRole = document.getElementById('assigneeRole').value;

        if (!name || !estimatedHours) {
            alert('Please fill in all required fields');
            return;
        }

        fetch('{% url "project_management:api_add_template_task" template.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                name: name,
                description: description,
                estimated_hours: parseFloat(estimatedHours),
                assignee_role: assigneeRole
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error adding task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding task');
        });
    }

    function removeTask(taskId, taskName) {
        if (!confirm(`Are you sure you want to remove "${taskName}" from this template?`)) {
            return;
        }

        fetch(`{% url "project_management:api_remove_template_task" template.id 0 %}`.replace('/0/', `/${taskId}/`), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error removing task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing task');
        });
    }

    function duplicateTemplate() {
        alert('Duplicate template functionality will create a copy of this template.');
        // TODO: Implement duplication
    }
    {% endif %}

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<!-- Custom template filter for dictionary access -->
{% load static %}
{% endblock %}
