{% extends 'base.html' %}
{% load static %}

{% block title %}Reminders for {{ event.event_number }} - Krystal Platform{% endblock %}

{% block extra_css %}
<style>
    .reminder-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.2s;
    }
    .reminder-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .reminder-card.sent {
        border-left-color: #28a745;
        background-color: #f8fff9;
    }
    .reminder-card.pending {
        border-left-color: #ffc107;
        background-color: #fffef8;
    }
    .reminder-card.overdue {
        border-left-color: #dc3545;
        background-color: #fff8f8;
    }
    .channel-icon {
        font-size: 1.2rem;
        margin-right: 5px;
    }
    .channel-icon.active {
        color: #0d6efd;
    }
    .channel-icon.inactive {
        color: #dee2e6;
    }
    .channel-icon.sent {
        color: #28a745;
    }
    .channel-icon.error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-bell"></i> Reminders for Event {{ event.event_number }}</h2>
                <p class="text-muted">{{ event.customer_company }} - {{ event.planned_start_date|date:"M d, Y" }}</p>
            </div>
            <div>
                <a href="{% url 'event_management:reminder_create' event.pk %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Reminder
                </a>
                <a href="{% url 'event_management:event_detail' event.pk %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Event
                </a>
            </div>
        </div>
        <hr>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3>{{ reminders.count }}</h3>
                <p class="text-muted mb-0">Total Reminders</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h3>{{ pending_count }}</h3>
                <p class="text-muted mb-0">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h3>{{ sent_count }}</h3>
                <p class="text-muted mb-0">Sent</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h3>{{ overdue_count }}</h3>
                <p class="text-muted mb-0">Overdue</p>
            </div>
        </div>
    </div>
</div>

<!-- Reminders List -->
<div class="row">
    <div class="col-md-12">
        {% if reminders %}
            {% for reminder in reminders %}
            <div class="card reminder-card {% if reminder.sent %}sent{% elif reminder.send_datetime < now %}overdue{% else %}pending{% endif %} mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>
                                {{ reminder.title }}
                                {% if reminder.sent %}
                                    <span class="badge bg-success">Sent</span>
                                {% elif reminder.send_datetime < now %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                {% endif %}
                                <span class="badge bg-secondary">{{ reminder.get_reminder_type_display }}</span>
                            </h5>
                            <p class="mb-2">{{ reminder.message|truncatewords:30 }}</p>
                            <p class="text-muted mb-1">
                                <i class="fas fa-calendar"></i>
                                Scheduled: {{ reminder.send_datetime|date:"M d, Y g:i A" }}
                            </p>
                            {% if reminder.sent_at %}
                            <p class="text-success mb-1">
                                <i class="fas fa-check"></i>
                                Sent: {{ reminder.sent_at|date:"M d, Y g:i A" }}
                            </p>
                            {% endif %}
                            <p class="mb-0">
                                <i class="fas fa-users"></i>
                                Recipients: {{ reminder.recipients.count }}
                                {% if reminder.recipients.count > 0 %}
                                    ({% for recipient in reminder.recipients.all|slice:":3" %}{{ recipient.get_full_name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if reminder.recipients.count > 3 %}...{% endif %})
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <!-- Notification Channels -->
                            <div class="mb-3">
                                <h6 class="text-muted">Notification Channels</h6>
                                <div>
                                    <!-- Email -->
                                    <i class="fas fa-envelope channel-icon {% if reminder.email_sent %}sent{% elif reminder.email_error %}error{% elif reminder.send_email %}active{% else %}inactive{% endif %}"
                                       title="{% if reminder.email_sent %}Email sent successfully{% elif reminder.email_error %}Email error: {{ reminder.email_error }}{% elif reminder.send_email %}Email enabled{% else %}Email disabled{% endif %}"></i>

                                    <!-- SMS -->
                                    <i class="fas fa-sms channel-icon {% if reminder.sms_sent %}sent{% elif reminder.sms_error %}error{% elif reminder.send_sms %}active{% else %}inactive{% endif %}"
                                       title="{% if reminder.sms_sent %}SMS sent successfully{% elif reminder.sms_error %}SMS error: {{ reminder.sms_error }}{% elif reminder.send_sms %}SMS enabled{% else %}SMS disabled{% endif %}"></i>

                                    <!-- WeChat -->
                                    <i class="fab fa-weixin channel-icon {% if reminder.wechat_sent %}sent{% elif reminder.wechat_error %}error{% elif reminder.send_wechat %}active{% else %}inactive{% endif %}"
                                       title="{% if reminder.wechat_sent %}WeChat sent successfully{% elif reminder.wechat_error %}WeChat error: {{ reminder.wechat_error }}{% elif reminder.send_wechat %}WeChat enabled{% else %}WeChat disabled{% endif %}"></i>
                                </div>
                                {% if reminder.email_error %}
                                <small class="text-danger d-block mt-1">
                                    <i class="fas fa-exclamation-triangle"></i> Email: {{ reminder.email_error|truncatewords:5 }}
                                </small>
                                {% endif %}
                            </div>

                            <!-- Actions -->
                            <div class="btn-group-vertical" role="group">
                                <a href="{% url 'event_management:reminder_detail' reminder.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if not reminder.sent %}
                                <a href="{% url 'event_management:reminder_edit' reminder.pk %}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="sendReminder({{ reminder.pk }})">
                                    <i class="fas fa-paper-plane"></i> Send Now
                                </button>
                                <a href="{% url 'event_management:reminder_delete' reminder.pk %}" class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this reminder?')">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-3x mb-3"></i>
                <h5>No Reminders Yet</h5>
                <p>No reminders have been created for this event.</p>
                <a href="{% url 'event_management:reminder_create' event.pk %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create First Reminder
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendReminder(reminderId) {
    if (confirm('Send this reminder now to all recipients?')) {
        fetch(`/events/reminder/${reminderId}/send/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Reminder is being sent!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error sending reminder: ' + error);
        });
    }
}
</script>
{% endblock %}
